{% extends 'base/base.html'%}
{% block TitlePage %}
  {{ 'Empleados' }}
{% endblock %}
{% block body %}
    <div class="container">
      <!-- Breadcrumbs-->
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#">Restaurant</a>
        </li>
        <li class="breadcrumb-item active">Empleados</li>
      </ol>
      <!-- Example DataTables Card-->
      <div class="card mb-3">
        <div class="card-header">
          <i class="fa fa-table"></i> Empleados
          <button id="btn-registrar-empleado" type="button" class="btn btn-success btn-sm">Registrar</button>
        </div>
        <div class="card-body">
          <br>
          <div class="table-responsive">
            <table class="table table-bordered" id="tableEmpleados" width="100%" cellspacing="0">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Puesto</th>
                  <th width="150px"></th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>
    </div>

    {% include 'base/modal.html' %}

{% endblock %}
{% block JavaScriptFiles %}
  <script type="text/javascript">
    //Variable global para Editar y Eliminar
    var idAsignacion;
    var empleado;

    $(document).ready(function(){
      //Inicializar variables
      idAsignacion = "";
      empleado = {};
      //alert('Funciona JQuery!');
      cargarDatos();
    });

    //Abrir Modal de Formulario de Registro de Empleado
    $(document).on("click", "#btn-registrar-empleado", function(){
      idAsignacion = "";
      $("#cargarForm").html(`{% include 'restaurant_application/empleados/formulario.html' %}`);
      $(".modal-dialog").attr("class", "modal-dialog modal-lg");
      $("#btn-guardar").attr({value:"{% url 'restaurant:create_empleado' %}"});
      $("#fecha_nacimiento").datepicker({dateFormat: 'dd/mm/yy'});
      $("#fecha_contratacion").datepicker({dateFormat: 'dd/mm/yy'});
      $("#labelModal").html("Registrar Empleado");
      $("#modal").modal("show");
    });

    function verDetalleEmpleado(){
      $("#cargarForm").html(`{% include 'restaurant_application/empleados/formulario_detalle.html' %}`);
      $(".modal-dialog").attr("class", "modal-dialog modal-lg");
      $("#labelModal").html("Detalle de Empleado");
      $.ajax({
        url : "{% url 'restaurant:detalle_empleado' %}",
        data : {'id': idAsignacion},
        type: "GET",
        dataType: "json",
        success : function (data) {
          $("#lblNombre").html(data[0].empleado.nombre);
          $("#lblApellido").html(data[0].empleado.apellido);
          var fecha_nacimiento = data[0].empleado.fecha_nacimiento;
          data[0].empleado.fecha_nacimiento = fecha_nacimiento.substr(8,2)+"/"+fecha_nacimiento.substr(5,2)+"/"+fecha_nacimiento.substr(0,4);
          $("#lblFechaNacimiento").html(data[0].empleado.fecha_nacimiento);
          $("#lblDUI").html(data[0].empleado.dui.substr(0, 8)+'-'+data[0].empleado.dui.substr(8, 1));
          $("#lblNIT").html(data[0].empleado.nit.substr(0, 4)+'-'+data[0].empleado.nit.substr(4, 6)+'-'+data[0].empleado.nit.substr(10, 3)+'-'+data[0].empleado.nit.substr(13, 1));
          $("#lblAFP").html(data[0].empleado.afp);
          $("#lblPuesto").html(data[0].puesto.puesto);
          $("#lblSalario").html(data[0].salario);
          var fecha_contratacion = data[0].fecha_contratacion;
          data[0].fecha_contratacion = fecha_contratacion.substr(8,2)+"/"+fecha_contratacion.substr(5,2)+"/"+fecha_contratacion.substr(0,4);
          $("#lblFechaContratacion").html(data[0].fecha_contratacion);
          empleado = data;
          $("#modal").modal("show");
        }
      });
    }

    //Abrir Ventana Modal Ver
    $(document).on("click", ".ver", function(){
      idAsignacion = $(this).attr("value");
      verDetalleEmpleado();
    })

    $(document).on("click", '.cancelar', function(){
      verDetalleEmpleado();
    });

    //Mostrar Formulario Editar
    $(document).on("click", "#btn-editar", function(){
      $("#labelModal").html("Editar Empleado");
      $("#cargarForm").html(`{% include 'restaurant_application/empleados/formulario.html' %}`);
      $("#labelModal").html("Editar Empleado");
      $("#btn-guardar").attr({value:"{% url 'restaurant:editar_empleado' %}"});
      $("#txtNombre").val(empleado[0].empleado.nombre);
      $("#txtApellido").val(empleado[0].empleado.apellido);
      $("#fecha_nacimiento").datepicker({dateFormat: 'dd/mm/yy'});
      $("#fecha_nacimiento").val(empleado[0].empleado.fecha_nacimiento);
      $("#txtDUI").val(empleado[0].empleado.dui);
      $("#txtNIT").val(empleado[0].empleado.nit);
      $("#txtAFP").val(empleado[0].empleado.afp);
      $("#selectPuesto").val(empleado[0].puesto.idPuesto);
      $("#txtSalario").val(empleado[0].salario);
      $("#fecha_contratacion").datepicker({dateFormat: 'dd/mm/yy'});
      $("#fecha_contratacion").val(empleado[0].fecha_contratacion);
    });

    //Función para guardar el formulario
    $(document).on("click", "#btn-guardar", function(){
      var fecha_nacimiento = $("#fecha_nacimiento").datepicker('getDate');
      fecha_nacimiento = fecha_nacimiento.getFullYear()+"-"+(fecha_nacimiento.getMonth()+1)+"-"+fecha_nacimiento.getDate();
      var fecha_contratacion = $("#fecha_contratacion").datepicker('getDate');
      fecha_contratacion = fecha_contratacion.getFullYear()+"-"+(fecha_contratacion.getMonth()+1)+"-"+fecha_contratacion.getDate();
      var nombre = $("#txtNombre").val();
      var apellido = $("#txtApellido").val();
      var dui = $("#txtDUI").val();
      var nit = $("#txtNIT").val();
      var afp = $("#txtAFP").val();
      var idPuesto = $("#selectPuesto").val();
      var salario = $("#txtSalario").val();
      var parametros;
      if(idAsignacion == ""){
        //En caso que sea Guardar
        parametros = {
          'nombre': nombre,
          'apellido': apellido,
          'fecha_nacimiento': fecha_nacimiento,
          'dui': dui,
          'nit': nit,
          'afp': afp,
          'idPuesto': idPuesto,
          'salario': salario,
          'fecha_contratacion': fecha_contratacion
        };

      } else{
        //En caso que sea Editar
        parametros = {
          'id': empleado[0].id,
          'idEmpleado': empleado[0].empleado.idEmpleado,
          'nombre': nombre,
          'apellido': apellido,
          'fecha_nacimiento': fecha_nacimiento,
          'dui': dui,
          'nit': nit,
          'afp': afp,
          'idPuesto': idPuesto,
          'salario': salario,
          'fecha_contratacion': fecha_contratacion
        };
      }

      $.ajax({
        url : $(this).attr("value"),
        data : parametros,
        type: "GET",
        dataType: "json",
        success : function (data) {
          //alert('Registrado '+data.respuesta);
          if(idAsignacion == ""){
            $("#modal").modal("hide");
          } else{
            verDetalleEmpleado();
          }
          cargarDatos();
        }
      });
    });

    //Abrir ventana eliminar
    $(document).on("click", "#btn-ver-eliminar", function(){
      $("#cargarForm").html(`{% include 'restaurant_application/empleados/delete.html' %}`);
      $("#labelModal").html("Eliminar Empleado");
      $("#nombreEmpleado").html(empleado[0].empleado.nombre+" "+empleado[0].empleado.apellido);
    });

    //Confirmar eliminar
    $(document).on("click", "#btn-eliminar", function(){
      $.ajax({
        url : "{% url 'restaurant:eliminar_empleado' %}",
        data : {'idEmpleado': empleado[0].empleado.idEmpleado, 'id':empleado[0].id},
        type: "GET",
        dataType: "json",
        success : function (data) {
          //alert('Eliminar '+data.respuesta);
          $("#modal").modal("hide");
          cargarDatos();
        }
      });
    });

    //Funcion cargar lista
    function cargarDatos(){
      $.ajax({
        url : "{% url 'restaurant:lista_empleados' %}",
        type: 'GET',
        dataType: "json",
        success : function (data) {
          dataE = data;
          $("#tableEmpleados").DataTable({
            destroy: true,
            data : data,
            ordering: false,
            columns: [
              { "data": "empleado.idEmpleado" },
              { "data": "empleado.nombre" },
              { "data": "empleado.apellido" },
              { "data": "puesto.puesto" },
              { sortable: false,
                "render": function ( data, type, full, meta ) {
                  var id = full.id;
                  var htmlButton = '<button type=\"button\" class=\"btn btn-outline-info btn-sm ver\" value='+id+'><i class="fa fa-eye" aria-hidden="true"></i></button>';
                    return htmlButton;
              }},
            ]
          });
        }
      });
    }
  </script>
{% endblock %}
