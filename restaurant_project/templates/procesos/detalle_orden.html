{% extends 'base/base.html'%}
{% load staticfiles %}
{% block TitlePage %}
  {{ 'Detalle Orden' }}
{% endblock %}
{% block body %}
    <div class="container-fluid">

        <div class="row">
          <div class="col-8">
            <div class="row">
              <div class="card mb-3">
                <div class="card-header">
                  <i class="fa fa-bar-chart"></i>Datos de Orden
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <label>Empleado:</label>
                      <strong>{{ object.mesero.nombre }}&nbsp;{{ object.mesero.apellido }}</strong>
                    </div>
                    <div class="col-md-4">
                      <label>Cliente:</label>
                      <strong>{{ object.cliente }}</strong>
                    </div>
                    <div class="col-md-4">
                      <label>Estado:</label>
                      <strong>{{ object.estado }}</strong>
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-md-8">
                      <label>Comentario:</label>
                      <strong>{{ object.comentario }}</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
                <div id="categorias">
                  <ul class="nav nav-tabs" id="tabCategorias" role="tablist">

                  </ul>
                  <div class="tab-content" id="tabPlatillos">

                </div>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card mb-3">
              <div class="card-header">
                <i class="fa fa-bar-chart"></i>Detalle de Orden
              </div>
              <div class="card-body">
                <div class="row">
                  <div id="agregandoPlatillos" class="col-12">

                  </div>
                </div>
                <hr>
                <div id="total" class="row">
                  <div class="col-md-8">
                    <label>Total:</label>
                    <strong>$ <span id="lblTotal">00.00</span></strong>
                  </div>
                </div>
                <hr>
                <div id="calculadora" class="row lado-izquierdo">
                  <div class="col-sm-12">
                    <div class="row">
                      <div class="sobre opcion-numero" value="1">
                        <h1>1</h1>
                      </div>
                      <div class="sobre opcion-numero" value="2">
                        <h1>2</h1>
                      </div>
                      <div class="sobre opcion-numero" value="3">
                        <h1>3</h1>
                      </div>
                      <div id="opcion-cantidad" class="sobre opcion config-opcion opcion-deseleccionada" value="cantidad">
                        <h3>Cantidad</h3>
                      </div>
                    </div>
                    <div class="row">
                      <div class="sobre opcion-numero" value="4">
                        <h1>4</h1>
                      </div>
                      <div class="sobre opcion-numero" value="5">
                        <h1>5</h1>
                      </div>
                      <div class="sobre opcion-numero" value="6">
                        <h1>6</h1>
                      </div>
                      <div id="opcion-precio" class="sobre opcion config-opcion opcion-deseleccionada" value="precio">
                        <h3>Precio</h3>
                      </div>
                    </div>
                    <div class="row">
                      <div class="sobre opcion-numero" value="7">
                        <h1>7</h1>
                      </div>
                      <div class="sobre opcion-numero" value="8">
                        <h1>8</h1>
                      </div>
                      <div class="sobre opcion-numero" value="9">
                        <h1>9</h1>
                      </div>
                      <div id="opcion-descuento" class="sobre opcion config-opcion opcion-deseleccionada" value="descuento">
                        <h3>% Descuento</h3>
                      </div>
                    </div>
                    <div class="row">
                      <div class="sin-digito">
                        <h1></h1>
                      </div>
                      <div class="sobre opcion-numero" value="0">
                        <h1>0</h1>
                      </div>
                      <div class="sobre opcion-numero" value=".">
                        <h1>.</h1>
                      </div>
                      <div id="borrar" class="sobre config-opcion opcion-borrar">
                        <h1><i class="fa fa-times" aria-hidden="true"></i></h1>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    {% include 'base/modal.html' %}

{% endblock %}
{% block JavaScriptFiles %}
<script src="{% static 'js/accounting.min.js' %}"></script>

  <script type="text/javascript">

    //Variable codigoPlatillo
    var codigoPlatillo;
    var idDetalleGuardado;
    var accion;
    var idDetalle;
    var contadorClick;
    var clickEliminar;
    $(document).ready(function(){
      codigoPlatillo = "";
      accion = "";
      idDetalleGuardado = "";
      idDetalle = "";
      contadorClick = 0;
      clickEliminar = 0;
      llenarCategorias();
      cargarListaDetalles();
    });

    //Agregar platillos
    $(document).on("click", ".platillo-card", function(){
      var codigoPlatillo = $(this).attr("value");
      var validar = false;
      for(var i = 0; i < $(".platillo_select").toArray().length; i++){
        if($(".platillo_select:eq("+i+")").attr("value") == codigoPlatillo){
          var cantidad = parseInt($(".platillo_select #lblCantidad:eq("+i+")").html());
          cantidad++;
          $(".platillo_select #lblCantidad:eq("+i+")").html(cantidad);
          idDetalle = i;
          calcularPrecio();
          validar = true;
          var descuento = 0;
          if($(".platillo_select #porcentajeDescuento:eq("+i+")").html() != ""){
            decuento = $(".platillo_select #porcentajeDescuento:eq("+i+")").html();
          }
          var id = $(".platillo_select .col-12:eq("+i+")").attr("id");
          var precio = $(".platillo_select #lblPrecioUnitario:eq("+i+")").html();
          actualizar(id, cantidad, precio, descuento);
        }
      }

      if(!validar){
        $.ajax({
          url : "{% url 'restaurant:platillo_detail' %}",
          data : {codigoPlatillo: codigoPlatillo},
          type: "GET",
          dataType: "json",
          success : function (data) {
            var parametros = {
              id: {{object.id}},
              codigoPlatillo: codigoPlatillo,
              precio: data[0].precioUnitario,
            };

            $.ajax({
              url : "{% url 'procesos:create_detalle_orden' %}",
              data : parametros,
              type: "GET",
              dataType: "json",
              success: function(data_create) {
                var cont = $(".platillo_select").toArray().length++;
                var htmlRow = `<div id="${cont}" class="row platillo_select" value="${data[0].codigoPlatillo}">
                                  <div id="${data_create.id}" class="col-12" value="registrado">
                                    <div class="row">
                                      <div class="col-8">
                                        <label id="lblNombrePlatillo">${data[0].nombre}</label>
                                      </div>
                                      <div class="col-4">
                                        <label>$&nbsp;<span id="lblPrecio">${(parseFloat(data[0].precioUnitario).toFixed(2))}</span></label>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col-3">
                                        <label>cant: <span id="lblCantidad">1</span></label>
                                      </div>
                                      <div class="col-4">
                                        <label>$&nbsp;<span id="lblPrecioUnitario">${data[0].precioUnitario}</span>&nbsp;c/u</label>
                                      </div>
                                      <div class="col-4">
                                        <label><span id="porcentajeDescuento"></span><span id="lblDescuento"></span></label>
                                      </div>
                                    </div>
                                  </div>
                                 </div>`;
                  $("#agregandoPlatillos").html($("#agregandoPlatillos").html()+htmlRow);
                  idDetalle = cont;
                  calcularPrecio();
              }
            });

          }
        });
      }
    });

    //Actualizar
    function actualizar(id, cantidad, precio, descuento){
      $.ajax({
        url : "{% url 'procesos:update_detalle_orden' %}",
        data : {
          id: id,
          cantidad: cantidad,
          precio: precio,
          descuento: descuento
        },
        type: "GET",
        dataType: "json",
        success: function (data) {
          //alert("Actualizado"+data.respuesta);
        }
      });
    }

    //Cargar la lista de los guardados anteriormente
    function cargarListaDetalles(){
      $("#agregandoPlatillos").html("");
      $.ajax({
        url : "{% url 'procesos:detail_detalle_orden' %}",
        data : {id: {{object.id}}},
        type: "GET",
        dataType: "json",
        success : function (data) {
          var htmlRegistrado = "";
          for(var i = 0; i < data.length; i++){
            htmlRegistrado = `<div id="${$(".platillo_select").toArray().length++}" class="row platillo_select" value="${data[i].consumible.codigoPlatillo}">
                                <div id="${data[i].id}" class="col-12" value="registrado">
                                  <div class="row">
                                    <div class="col-8">
                                      <label id="lblNombrePlatillo">${data[i].consumible.nombre}</label>
                                    </div>
                                    <div class="col-4">
                                      <label>$&nbsp;<span id="lblPrecio"></span></label>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-3">
                                      <label>cant: <span id="lblCantidad">${data[i].cantidad}</span></label>
                                    </div>
                                    <div class="col-4">
                                      <label>$&nbsp;<span id="lblPrecioUnitario">${data[i].precio_de_venta}</span>&nbsp;c/u</label>
                                    </div>
                                    <div class="col-4">
                                      <label>
                                        <span id="porcentajeDescuento">`;
                                        if(data[i].descuento != 0){
                                          htmlRegistrado += data[i].descuento+`</span><span id="lblDescuento">% desc</span>`;
                                        } else{
                                          htmlRegistrado += `</span><span id="lblDescuento"></span>`;
                                        }

                                        htmlRegistrado += `

                                      </label>
                                    </div>
                                  </div>
                                </div>
                               </div>`;
                               idDetalle = i;
                               $("#agregandoPlatillos").html($("#agregandoPlatillos").html()+htmlRegistrado);
                               calcularPrecio();

          }
        }
      });
    }

    //Seleccionar platillo en detalle orden
    $(document).on("click", ".platillo_select", function(){
      idDetalle = $(this).attr("id");
      idDetalleGuardado = $(".platillo_select .col-12:eq("+idDetalle+")").attr("id");
      $(".platillo_select").removeClass("platillo_select_elegido");
      $(this).addClass("platillo_select_elegido");
      removerClass();
      $("#opcion-cantidad").addClass("opcion-seleccionada");
      accion = "cantidad";
      contadorClick = 1;
    });

    //Cambiar de color en las siguientes opciones
    $(document).on("click", ".opcion", function(){
      removerClass();
      $(this).addClass("opcion-seleccionada");
      accion = $(this).attr("value");
      contadorClick = 1;
    });

    //Agregar Número
    $(document).on("click", ".opcion-numero", function(){
      if(idDetalleGuardado == ""){
        //alert("No se puede");
        noSeleccionado();
      } else{
        if (accion == "cantidad"){
          if(contadorClick == 1){
            if($(this).attr("value") == "."){
              $(".platillo_select #lblCantidad:eq("+idDetalle+")").html("0.");
            } else{
              $(".platillo_select #lblCantidad:eq("+idDetalle+")").html($(this).attr("value"));
            }
            contadorClick++;
          } else if($(".platillo_select #lblCantidad:eq("+idDetalle+")").html().indexOf(".") == -1){
            $(".platillo_select #lblCantidad:eq("+idDetalle+")").html($(".platillo_select #lblCantidad:eq("+idDetalle+")").html()+$(this).attr("value"));
          } else{
            if($(this).attr("value") != "."){
              $(".platillo_select #lblCantidad:eq("+idDetalle+")").html($(".platillo_select #lblCantidad:eq("+idDetalle+")").html()+$(this).attr("value"));
            }
          }
          clickEliminar = 0;
        } else if (accion == "precio") {
          if(contadorClick == 1){
            if($(this).attr("value") == "."){
              $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html("0.");
            } else{
              $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html($(this).attr("value"));
            }
            contadorClick++;
          } else if($(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html().indexOf(".") == -1){
            $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html($(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html()+$(this).attr("value"));
          } else{
            if($(this).attr("value") != "."){
              $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html($(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html()+$(this).attr("value"));
            }
          }

        } else if (accion == "descuento") {
          var desc;
          var simbolo_agregado;
          if($(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html() == null){
            alert($(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html());
          }
          if(contadorClick == 1){
            desc = "";
            if($(this).attr("value") == "."){
              simbolo_agregado = "0.";
            } else{
              simbolo_agregado = $(this).attr("value");
            }
            contadorClick++;
          } else if($(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html().indexOf(".") == -1){
            desc = $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html();
            simbolo_agregado = $(this).attr("value");
          } else{
            desc = $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html();
            if($(this).attr("value") != "."){
              simbolo_agregado = $(this).attr("value");
            } else{
              simbolo_agregado = "";
            }
          }
          $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html(desc+simbolo_agregado);
          $(".platillo_select #lblDescuento:eq("+idDetalle+")").html("% desc");
        }
        guardarCambios();
      }
    });

    function noSeleccionado(){
      $("#cargarForm").html(`
                              <div class="modal-body">
                                  <h3><strong>No se ha seleccionado detalle.</strong></h3>
                              </div>
                              <div class="modal-footer">
                              </div>
                            `);
      $("#labelModal").html("Seleccionar Detalle");
      $("#modal").modal("show");
    }

    //Borrar ultimo caracter
    $(document).on("click", "#borrar", function(){
      if(idDetalleGuardado == ""){
        //alert("No se puede");
        noSeleccionado();
      } else{

        var numero;
        if (accion == "cantidad"){
          numero = $(".platillo_select #lblCantidad:eq("+idDetalle+")").html().substring(0,$(".platillo_select #lblCantidad:eq("+idDetalle+")").html().length-1);
          if(numero == ""){
            $(".platillo_select #lblCantidad:eq("+idDetalle+")").html("0");
          } else{
            $(".platillo_select #lblCantidad:eq("+idDetalle+")").html(numero);
          }
        } else if (accion == "precio") {
          numero = $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html().substring(0,$(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html().length-1);
          if(numero == ""){
            $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html("0");
          } else{
            $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html(numero);
          }
        } else if (accion == "descuento") {
          numero = $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html().substring(0,$(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html().length-1);
          if(numero == ""){
            $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html("0");
          } else{
            $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html(numero);
          }
        }
        guardarCambios();
      }
    });

    //Remover color a los demás opciones de calculadora
    function removerClass(){
      $(".opcion").removeClass("opcion-seleccionada");
      $(".opcion").addClass("opcion-deseleccionada");
    }

    //Calcular total
    function calcularTotal(){
      var total = 0;
      for(var i = 0; i < $(".platillo_select").toArray().length; i++){
        total += parseFloat($(".platillo_select #lblPrecio:eq("+i+")").html());
      }
      //alert(total);
      $("#lblTotal").html(parseFloat(total).toFixed(2));
    }

    //Calcular Precio Unitario al editar
    function calcularPrecio(){
      var cantidad = parseFloat($(".platillo_select #lblCantidad:eq("+idDetalle+")").html()).toFixed(2);
      var preciounitario = parseFloat($(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html()).toFixed(2);
      var descuento;
      if($(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html() == ""){
        descuento = 0;
      } else{
        descuento = parseFloat($(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html()).toFixed(2)/100;
      }
      var total = parseFloat(cantidad*preciounitario).toFixed(2)
      var diferencia = parseFloat(descuento*total).toFixed(2);
      $(".platillo_select #lblPrecio:eq("+idDetalle+")").html(parseFloat(total-diferencia).toFixed(2));

      if(cantidad == 0){
        clickEliminar++;
      }
      if(clickEliminar >= 2){
        $(".platillo_select:eq("+idDetalle+")").remove();
        $.ajax({
          url : "{% url 'procesos:delete_detalle_orden' %}",
          data : {id: idDetalleGuardado},
          type: "GET",
          dataType: "json",
          success : function (data) {
            console.log("Eliminado"+data.respuesta);
            idDetalleGuardado = "";
          }
        });
        for(var i = 0; i < $(".platillo_select").toArray().length; i++){
          $(".platillo_select:eq("+i+")").attr("id",i);
        }
        clickEliminar = 0;
      }
      calcularTotal();
    }

    //Hacer efecto al borrar caracter o agregar caracter
    function guardarCambios(){
      var id = $(".platillo_select .col-12:eq("+idDetalle+")").attr("id");
      var cantidad = $(".platillo_select #lblCantidad:eq("+idDetalle+")").html();
      var precio = $(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html();
      var descuento = 0;
      if($(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html() != ""){
        descuento = $(".platillo_select #porcentajeDescuento:eq("+idDetalle+")").html();
      }

      actualizar(id, cantidad, precio, descuento);
      calcularPrecio();
    }

    // Simular click para minimizar el nav
    $("#sidenavToggler > i").click();

    function llenarCategorias()
    {
      let ul = $("#tabCategorias"), htmlUL = ``;
      let div = $("#tabPlatillos"), htmlDIV = ``;
      $.ajax({
        url: "{% url 'restaurant:lista_categoria_platillos_con_platillos' %}",
        type: 'get',
        dataType: 'json',
        success: (data) => {
          //console.log(data);
          for(let i = 0; i < data.length; i++)
          {
            if(i == 0){
              htmlUL += `<li class="nav-item">
                          <a class="nav-link active" id="${data[i].idCategoriaPlatillo}-tab" data-toggle="tab" href="#${data[i].idCategoriaPlatillo}" role="tab" aria-controls="${data[i].idCategoriaPlatillo}" aria-selected="true">${data[i].categoria}</a>
                        </li>`;
              htmlDIV += `<div class="tab-pane fade show active" id="${data[i].idCategoriaPlatillo}" role="tabpanel" aria-labelledby="${data[i].idCategoriaPlatillo}-tab">`;
              for(let j = 0; j < data[i].platillos.length; j++){
                htmlDIV +=`
                <div class="card bg-light mb-3  text-center platillo-card" value="${data[i].platillos[j].codigoPlatillo}" style="width: 12rem;">
                  <div class="card-body">
                    <p class="card-text">
                        ${data[i].platillos[j].nombre}
                    </p>
                    <div class="card-footer bg-transparent">
                        ${accounting.formatMoney(data[i].platillos[j].precioUnitario)}
                    </div>
                  </div>
                </div>
                `;
              }
              htmlDIV += `</div>`;
            }
            else{
              htmlUL +=  `
              <li class="nav-item">
                <a class="nav-link" id="${data[i].idCategoriaPlatillo}-tab" data-toggle="tab" href="#${data[i].idCategoriaPlatillo}" role="tab" aria-controls="${data[i].idCategoriaPlatillo}" aria-selected="false">${data[i].categoria}</a>
              </li>`;
              htmlDIV += `<div class="tab-pane fade" id="${data[i].idCategoriaPlatillo}" role="tabpanel" aria-labelledby="${data[i].idCategoriaPlatillo}-tab">`;
              for(let j = 0; j < data[i].platillos.length; j++){
                htmlDIV +=`
                <div class="card bg-light mb-3  text-center platillo-card" value="${data[i].platillos[j].codigoPlatillo}" style="width: 12rem;">
                  <div class="card-body">
                    <p class="card-text">
                        ${data[i].platillos[j].nombre}
                    </p>
                    <div class="card-footer bg-transparent">
                        ${accounting.formatMoney(data[i].platillos[j].precioUnitario)}
                    </div>
                  </div>
                </div>
                `;
              }
              htmlDIV += `</div>`;

            }

          }
          ul.html(htmlUL);
          div.html(htmlDIV);
        }
      });
    }


  </script>
  <style>
    .platillo-card
    {
      display: inline-block; cursor: pointer;
      min-width: 50px;
      margin: 3px;
    }
    .nav-link
    {
      padding-left: 6px;
      padding-right: 6px;
    }
    .platillo_select:hover, .platillo_select_elegido{
      color: black;
      border-left-width: 5px;
      border-left-style: solid;
      border-left-color: #0097A7;
    }
    .opcion-numero{
      background-color: #00BCD4;
      width: 50px;
      height: 50px;
      margin-top: 5px;
      margin-right: 5px;
      border-radius: 5px;
      text-align: center;
    }
    .opcion-numero:hover{
      background-color: #0097A7;

    }
    .sin-digito{
      width: 50px;
      height: 50px;
      margin-top: 5px;
      margin-right: 5px;
      border-radius: 5px;
    }
    .platillo_select:hover, #lblNombrePlatillo:hover, #lblPrecio:hover, #lblCantidad:hover, #lblPrecioUnitario:hover, #porcentajeDescuento:hover, .sobre:hover{
      cursor: pointer;
    }
    .config-opcion{
      width: 165px;
      height: 50px;
      margin-top: 5px;
      margin-right: 5px;
      padding-top: 7px;
      border-radius: 5px;
      text-align: center;
    }
    .opcion-seleccionada{
      background-color: #795548 !important;
    }
    .opcion-deseleccionada{
      background-color: #C0CA33;
    }
    .opcion-borrar{
      background-color: #ef5350;
      padding-top: 2px !important;
    }
    .lado-izquierdo{
      margin-left: 10px;
    }
  </style>
{% endblock %}
