{% extends 'base/base.html'%}
{% load staticfiles %}
{% block TitlePage %}
  {{ 'Detalle Orden' }}
{% endblock %}
{% block body %}
    <div class="container-fluid">

        <div class="row">
          <div class="col-8">
            <div class="row">
              <div class="card mb-3">
                <div class="card-header">
                  <i class="fa fa-bar-chart"></i>Datos de Orden
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <label>Empleado:</label>
                      <strong>{{ object.mesero.nombre }}&nbsp;{{ object.mesero.apellido }}</strong>
                    </div>
                    <div class="col-md-4">
                      <label>Cliente:</label>
                      <strong>{{ object.cliente }}</strong>
                    </div>
                    <div class="col-md-4">
                      <label>Estado:</label>
                      <strong>{{ object.estado }}</strong>
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-md-8">
                      <label>Comentario:</label>
                      <strong>{{ object.comentario }}</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
                <div id="categorias">
                  <ul class="nav nav-tabs" id="tabCategorias" role="tablist">

                  </ul>
                  <div class="tab-content" id="tabPlatillos">

                </div>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card mb-3">
              <div class="card-header">
                <i class="fa fa-bar-chart"></i>Detalle de Orden
              </div>
              <div class="card-body">
                <div class="row">
                  <div id="agregandoPlatillos" class="col-12">

                  </div>
                </div>
                <hr>
                <div id="total" class="row">
                  <div class="col-md-8">
                    <label>Total:</label>
                    <strong>$ <span id="lblTotal">00.00</span></strong>
                  </div>
                </div>
                <hr>
                <div id="calculadora" class="row">
                  <div class="col-sm-12">
                    <div class="row">
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="1"><span class="badge badge-secondary">1</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="2"><span class="badge badge-secondary">2</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="3"><span class="badge badge-secondary">3</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-4">
                        <h1 id="opcion-cantidad" class="sobre"><span class="badge badge-secondary opcion" value="cantidad">Cantidad</span></h1>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="4"><span class="badge badge-secondary">4</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="5"><span class="badge badge-secondary">5</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="6"><span class="badge badge-secondary">6</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-4">
                        <h1 id="opcion-precio" class="sobre"><span class="badge badge-secondary opcion" value="precio">Precio</span></h1>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="7"><span class="badge badge-secondary">7</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="8"><span class="badge badge-secondary">8</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="9"><span class="badge badge-secondary">9</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-4">
                        <h1 id="opcion-descuento" class="sobre"><span class="badge badge-secondary opcion" value="descuento">Descuento</span></h1>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-sm-2">
                        <h1><span class="badge badge-secondary"></span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre opcion-numero" value="0"><span class="badge badge-secondary">0</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-2">
                        <h1 class="sobre"><span class="badge badge-secondary">.</span></h1>&nbsp;&nbsp;
                      </div>
                      <div class="col-sm-4">
                        <h1 class="sobre"><span class="badge badge-secondary"><i class="fa fa-window-close" aria-hidden="true"></i></span></h1>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    {% include 'base/modal.html' %}

{% endblock %}
{% block JavaScriptFiles %}
<script src="{% static 'js/accounting.min.js' %}"></script>

  <script type="text/javascript">

    //Variable codigoPlatillo
    var codigoPlatillo;
    var accion;
    var idDetalle;
    var contador;
    $(document).ready(function(){
      //alert(getUrlVars()["id"]);
      codigoPlatillo = "";
      accion = "";
      idDetalle = "";
      contador = 0;
      llenarCategorias();
    });

    //Para obtener parametros
    function getUrlVars() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
      });
      return vars;
    }

    //Agregar platillos
    $(document).on("click", ".platillo-card", function(){
      var codigoPlatillo = $(this).attr("value");
      $.ajax({
        url : "{% url 'restaurant:platillo_detail' %}",
        data : {codigoPlatillo: codigoPlatillo},
        type: "GET",
        dataType: "json",
        success : function (data) {
          //alert(data[0].nombre);
          var htmlRow = `<div id="${contador}" class="row platillo_select" value="${data[0].codigoPlatillo}">
                          <div class="col-12">
                            <div class="row">
                              <div class="col-8">
                                <label id="lblNombrePlatillo">${data[0].nombre}</label>
                              </div>
                              <div class="col-4">
                                <label>$&nbsp;<span id="lblPrecio">${(parseFloat(data[0].precioUnitario).toFixed(2))}</span></label>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-3">
                                <label>cant: <span id="lblCantidad">1</span></label>
                              </div>
                              <div class="col-4">
                                <label>$&nbsp;<span id="lblPrecioUnitario">${data[0].precioUnitario}</span>&nbsp;c/u</label>
                              </div>
                            </div>
                          </div>
                         </div>`
          $("#agregandoPlatillos").html($("#agregandoPlatillos").html()+htmlRow);
          contador++;
          calcularTotal();
        }
      });
    });
    //Seleccionar platillo en detalle orden
    $(document).on("click", ".platillo_select", function(){
      idDetalle = $(this).attr("id");
      $(".platillo_select").removeClass("platillo_select_elegido");
      $(this).addClass("platillo_select_elegido");
      removerClass();
      $("#opcion-cantidad .badge").addClass("badge-info");
      accion = "cantidad";
    });

    //Cambiar de color en las siguientes opciones
    $(document).on("click", ".opcion", function(){
      removerClass();
      $(this).addClass("badge-info");
      accion = $(this).attr("value");
    });

    //Agregar Número
    $(document).on("click", ".opcion-numero", function(){
      $(".platillo_select #lblCantidad:eq("+idDetalle+")").html($(".platillo_select #lblCantidad:eq("+idDetalle+")").html()+$(this).attr("value"));
      cantidad = parseFloat($(".platillo_select #lblCantidad:eq("+idDetalle+")").html()).toFixed(2);
      preciounitario = parseFloat($(".platillo_select #lblPrecioUnitario:eq("+idDetalle+")").html()).toFixed(2);
      //alert(cantidad*preciounitario);
      $(".platillo_select #lblPrecio:eq("+idDetalle+")").html(parseFloat(cantidad*preciounitario).toFixed(2));
      calcularTotal();
    });

    //Remover color a los demás opciones de calculadora
    function removerClass(){
      $(".opcion").removeClass("badge-info");
      $(".opcion").addClass("badge-secondary");
    }

    //Calcular total
    function calcularTotal(){
      var total = 0;
      for(var i = 0; i < $(".platillo_select").toArray().length; i++){
        total += parseFloat($(".platillo_select #lblPrecio:eq("+i+")").html());
      }
      //alert(total);
      $("#lblTotal").html(parseFloat(total).toFixed(2));
    }
    // Simular click para minimizar el nav
    $("#sidenavToggler > i").click();

    function llenarCategorias()
    {
      let ul = $("#tabCategorias"), htmlUL = ``;
      let div = $("#tabPlatillos"), htmlDIV = ``;
      $.ajax({
        url: "{% url 'restaurant:lista_categoria_platillos_con_platillos' %}",
        type: 'get',
        dataType: 'json',
        success: (data) => {
          console.log(data);
          for(let i = 0; i < data.length; i++)
          {
            if(i == 0){
              htmlUL += `<li class="nav-item">
                          <a class="nav-link active" id="${data[i].idCategoriaPlatillo}-tab" data-toggle="tab" href="#${data[i].idCategoriaPlatillo}" role="tab" aria-controls="${data[i].idCategoriaPlatillo}" aria-selected="true">${data[i].categoria}</a>
                        </li>`;
              htmlDIV += `<div class="tab-pane fade show active" id="${data[i].idCategoriaPlatillo}" role="tabpanel" aria-labelledby="${data[i].idCategoriaPlatillo}-tab">`;
              for(let j = 0; j < data[i].platillos.length; j++){
                htmlDIV +=`
                <div class="card bg-light mb-3  text-center platillo-card" value="${data[i].platillos[j].codigoPlatillo}" style="width: 12rem;">
                  <div class="card-body">
                    <p class="card-text">
                        ${data[i].platillos[j].nombre}
                    </p>
                    <div class="card-footer bg-transparent">
                        ${accounting.formatMoney(data[i].platillos[j].precioUnitario)}
                    </div>
                  </div>
                </div>
                `;
              }
              htmlDIV += `</div>`;
            }
            else{
              htmlUL +=  `
              <li class="nav-item">
                <a class="nav-link" id="${data[i].idCategoriaPlatillo}-tab" data-toggle="tab" href="#${data[i].idCategoriaPlatillo}" role="tab" aria-controls="${data[i].idCategoriaPlatillo}" aria-selected="false">${data[i].categoria}</a>
              </li>`;
              htmlDIV += `<div class="tab-pane fade" id="${data[i].idCategoriaPlatillo}" role="tabpanel" aria-labelledby="${data[i].idCategoriaPlatillo}-tab">`;
              for(let j = 0; j < data[i].platillos.length; j++){
                htmlDIV +=`
                <div class="card bg-light mb-3  text-center platillo-card" value="${data[i].platillos[j].codigoPlatillo}" style="width: 12rem;">
                  <div class="card-body">
                    <p class="card-text">
                        ${data[i].platillos[j].nombre}
                    </p>
                    <div class="card-footer bg-transparent">
                        ${accounting.formatMoney(data[i].platillos[j].precioUnitario)}
                    </div>
                  </div>
                </div>
                `;
              }
              htmlDIV += `</div>`;

            }

          }
          ul.html(htmlUL);
          div.html(htmlDIV);
        }
      });
    }


  </script>
  <style>
    .platillo-card
    {
      display: inline-block; cursor: pointer;
      min-width: 50px;
      margin: 3px;
    }
    .nav-link
    {
      padding-left: 6px;
      padding-right: 6px;
    }
    .platillo_select:hover{
      opacity: 0.7;
    }
    .platillo_select:hover, #lblNombrePlatillo:hover, #lblPrecio:hover, #lblCantidad:hover, #lblPrecioUnitario:hover, .sobre:hover{
      cursor: pointer;
    }
    .platillo_select_elegido{
      opacity: 0.7;
    }
  </style>
{% endblock %}
